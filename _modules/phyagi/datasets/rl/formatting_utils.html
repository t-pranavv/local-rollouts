
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>phyagi.datasets.rl.formatting_utils &#8212; PhyAGI</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=328381f7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/phyagi/datasets/rl/formatting_utils';</script>
    <link rel="canonical" href="https://microsoft.github.io/phyagi/_modules/phyagi/datasets/rl/formatting_utils.html" />
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Sep 16, 2025"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/logo.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../../../_static/logo.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">PhyAGI</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/build_docker.html">Build a Docker image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/quick_start.html">Quick start</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/configuration_system.html">Configuration system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/cli.html">Command-Line Interface (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/data_generation_infrastructure.html">Data generation infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/llama_cpp_and_gguf.html">Llama.cpp and GGUF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/data_related.html">Dataâ€‘related</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/model_architecture.html">Model architecture</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/training.html">Training</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/sft.html">Supervised Fine-Tuning (SFT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/rlhf.html">Reinforcement Learning from Human Feedback (RLHF)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/evaluation.html">Evaluation</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced_tutorials/lr_schedulers.html">Learning rate schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced_tutorials/optimizers.html">Optimizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced_tutorials/parameter_efficient.html">Parameter-Efficient Techniques (PEFT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../advanced_tutorials/batch_tracking.html">Batch tracking</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Azure</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/sc_alt.html">Log-In with SC-ALT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/pim.html">Elevate permissions with Privileged Identity Management (PIM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/singularity.html">Submiting jobs with Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/storage_account.html">Azure Storage Account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/virtual_machine.html">Azure Virtual Machine (VM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/container_registry.html">Azure Container Registry (ACR)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/app_service.html">Azure App Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/kubernetes_service.html">Azure Kubernetes Service (AKS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../azure/entra.html">Microsoft Entra</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/first_time_contributor.html">First time contributor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tests.html">Tests</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../api/datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/optimizers.html">Optimizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/trainers.html">Trainers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/rl.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/eval.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/cli.html">CLI</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/microsoft/phyagi" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/microsoft/phyagi/issues/new?title=Issue%20on%20page%20%2F_modules/phyagi/datasets/rl/formatting_utils.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for phyagi.datasets.rl.formatting_utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Microsoft Corporation.</span>
<span class="c1"># Licensed under the MIT license.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">Random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreTrainedTokenizerBase</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">phyagi.datasets.rl.special_tokens</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_mask_token</span><span class="p">,</span> <span class="n">get_special_token</span>

<span class="n">CHATML_CHAT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">% f</span><span class="s2">or message in messages %}{</span><span class="si">% i</span><span class="s2">f (message[&#39;role&#39;] == &#39;system&#39;) %}{{&#39;&lt;|im_start|&gt;system&lt;|im_sep|&gt;&#39; + message[&#39;content&#39;] + &#39;&lt;|im_end|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">lif (message[&#39;role&#39;] == &#39;user&#39;) %}{{&#39;&lt;|im_start|&gt;user&lt;|im_sep|&gt;&#39; + message[&#39;content&#39;] + &#39;&lt;|im_end|&gt;&lt;|im_start|&gt;assistant&lt;|im_sep|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">lif (message[&#39;role&#39;] == &#39;assistant&#39;) %}{{message[&#39;content&#39;] + &#39;&lt;|im_end|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">% e</span><span class="s2">ndfor %}&quot;</span>
<span class="n">PHI_CHAT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">% f</span><span class="s2">or message in messages %}{</span><span class="si">% i</span><span class="s2">f message[&#39;role&#39;] == &#39;system&#39; %}{{&#39;&lt;|system|&gt;</span><span class="se">\n</span><span class="s2">&#39; + message[&#39;content&#39;] + &#39;&lt;|end|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">lif message[&#39;role&#39;] == &#39;user&#39; %}{{&#39;&lt;|user|&gt;</span><span class="se">\n</span><span class="s2">&#39; + message[&#39;content&#39;] + &#39;&lt;|end|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">lif message[&#39;role&#39;] == &#39;assistant&#39; %}{{&#39;&lt;|assistant|&gt;</span><span class="se">\n</span><span class="s2">&#39; + message[&#39;content&#39;] + &#39;&lt;|end|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">% e</span><span class="s2">ndfor %}{</span><span class="si">% i</span><span class="s2">f add_generation_prompt %}{{ &#39;&lt;|assistant|&gt;</span><span class="se">\n</span><span class="s2">&#39; }}{</span><span class="si">% e</span><span class="s2">lse %}{{ eos_token }}{</span><span class="si">% e</span><span class="s2">ndif %}&quot;</span>
<span class="n">GEN_TEMPLATE_PATCHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;microsoft/phi-3-mini-128k-instruct&quot;</span><span class="p">:</span> <span class="s2">&quot;{</span><span class="si">% f</span><span class="s2">or message in messages %}{</span><span class="si">% i</span><span class="s2">f message[&#39;role&#39;] == &#39;system&#39; %}{{&#39;&lt;|system|&gt;</span><span class="se">\n</span><span class="s2">&#39; + message[&#39;content&#39;] + &#39;&lt;|end|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">lif message[&#39;role&#39;] == &#39;user&#39; %}{{&#39;&lt;|user|&gt;</span><span class="se">\n</span><span class="s2">&#39; + message[&#39;content&#39;] + &#39;&lt;|end|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">lif message[&#39;role&#39;] == &#39;assistant&#39; %}{{&#39;&lt;|assistant|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% g</span><span class="s2">eneration %}{{message[&#39;content&#39;] + &#39;&lt;|end|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">ndgeneration %}{{&#39;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">% e</span><span class="s2">ndfor %}{</span><span class="si">% i</span><span class="s2">f add_generation_prompt %}{{ &#39;&lt;|assistant|&gt;</span><span class="se">\n</span><span class="s2">&#39; }}{</span><span class="si">% e</span><span class="s2">lse %}{{ eos_token }}{</span><span class="si">% e</span><span class="s2">ndif %}&quot;</span><span class="p">,</span>
    <span class="s2">&quot;microsoft/phi-3-mini-4k-instruct&quot;</span><span class="p">:</span> <span class="s2">&quot;{</span><span class="si">% f</span><span class="s2">or message in messages %}{</span><span class="si">% i</span><span class="s2">f message[&#39;role&#39;] == &#39;system&#39; %}{{&#39;&lt;|system|&gt;</span><span class="se">\n</span><span class="s2">&#39; + message[&#39;content&#39;] + &#39;&lt;|end|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">lif message[&#39;role&#39;] == &#39;user&#39; %}{{&#39;&lt;|user|&gt;</span><span class="se">\n</span><span class="s2">&#39; + message[&#39;content&#39;] + &#39;&lt;|end|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">lif message[&#39;role&#39;] == &#39;assistant&#39; %}{{&#39;&lt;|assistant|&gt;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% g</span><span class="s2">eneration %}{{message[&#39;content&#39;] + &#39;&lt;|end|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">ndgeneration %}{{&#39;</span><span class="se">\n</span><span class="s2">&#39;}}{</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">% e</span><span class="s2">ndfor %}{</span><span class="si">% i</span><span class="s2">f add_generation_prompt %}{{ &#39;&lt;|assistant|&gt;</span><span class="se">\n</span><span class="s2">&#39; }}{</span><span class="si">% e</span><span class="s2">lse %}{{ eos_token }}{</span><span class="si">% e</span><span class="s2">ndif %}&quot;</span><span class="p">,</span>
    <span class="s2">&quot;microsoft/phi-4&quot;</span><span class="p">:</span> <span class="s2">&quot;{</span><span class="si">% f</span><span class="s2">or message in messages %}{</span><span class="si">% i</span><span class="s2">f (message[&#39;role&#39;] == &#39;system&#39;) %}{{&#39;&lt;|im_start|&gt;system&lt;|im_sep|&gt;&#39; + message[&#39;content&#39;] + &#39;&lt;|im_end|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">lif (message[&#39;role&#39;] == &#39;user&#39;) %}{{&#39;&lt;|im_start|&gt;user&lt;|im_sep|&gt;&#39; + message[&#39;content&#39;] + &#39;&lt;|im_end|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">lif (message[&#39;role&#39;] == &#39;assistant&#39;) %}{{&#39;&lt;|im_start|&gt;assistant&lt;|im_sep|&gt;&#39;}}{</span><span class="si">% g</span><span class="s2">eneration %}{{message[&#39;content&#39;] + &#39;&lt;|im_end|&gt;&#39;}}{</span><span class="si">% e</span><span class="s2">ndgeneration %}{</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">% e</span><span class="s2">ndfor %}{</span><span class="si">% i</span><span class="s2">f add_generation_prompt %}{{ &#39;&lt;|im_start|&gt;assistant&lt;|im_sep|&gt;&#39; }}{</span><span class="si">% e</span><span class="s2">ndif %}&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_generate_system_messages</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;You are an AI assistant that helps people find information.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You&#39;re Phi, a large language model trained by Microsoft to help users&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You are a kind and helpful assistant. Respond only with helpful, ethical responses, and avoid harmful or inappropriate content.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You are a kind, smart, capable, and helpful assistant. Give answers that aid the user, while being extremely technically adept&quot;</span><span class="p">,</span>
        <span class="s2">&quot;you are a good assistant do your best to answer questions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You are an AI assistant. You will be given a task. You must generate a detailed and long answer.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You are an AI assistant. User will you give you a task. Your goal is to complete the task as faithfully as you can. While performing the task think step-by-step and justify your steps.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You follow user instruction extremely well&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You are an AI assistant that follows instruction extremely well. Help as much as you can.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">messages</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_generate_chat_templates</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="n">user_token</span> <span class="o">=</span> <span class="n">get_special_token</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="n">assistant_token</span> <span class="o">=</span> <span class="n">get_special_token</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">,</span> <span class="s2">&quot;assistant&quot;</span><span class="p">)</span>
    <span class="n">end_token</span> <span class="o">=</span> <span class="n">get_special_token</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span>

    <span class="c1"># Additional blank roles are added to increase the variety of templates</span>
    <span class="n">base_roles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Question&quot;</span><span class="p">,</span> <span class="s2">&quot;Answer&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Message&quot;</span><span class="p">,</span> <span class="s2">&quot;Response&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Query&quot;</span><span class="p">,</span> <span class="s2">&quot;Response&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Query&quot;</span><span class="p">,</span> <span class="s2">&quot;Reply&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Problem&quot;</span><span class="p">,</span> <span class="s2">&quot;Solution&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Ask&quot;</span><span class="p">,</span> <span class="s2">&quot;Answer&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Input&quot;</span><span class="p">,</span> <span class="s2">&quot;Output&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Message&quot;</span><span class="p">,</span> <span class="s2">&quot;Response&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Instruction&quot;</span><span class="p">,</span> <span class="s2">&quot;Response&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Customer&quot;</span><span class="p">,</span> <span class="s2">&quot;Support&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># Extend the base roles with additional variations</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">base_roles</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">role</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">role</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">base_roles</span>
    <span class="p">]</span>

    <span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">random_seed</span> <span class="o">=</span> <span class="n">Random</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">roles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">add_user_newline</span><span class="p">,</span>
                <span class="n">add_assistant_newline</span><span class="p">,</span>
                <span class="n">add_user_colon</span><span class="p">,</span>
                <span class="n">add_assistant_colon</span><span class="p">,</span>
                <span class="n">add_newline_after_user_message</span><span class="p">,</span>
                <span class="n">add_newline_after_assistant_message</span><span class="p">,</span>
                <span class="n">add_newline_after_user_token</span><span class="p">,</span>
                <span class="n">add_space_after_user_token</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">combination</span>

            <span class="k">if</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newline_after_user_token</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">add_newline_after_user_token</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">newline_after_user_token</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">newline_after_user_token</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">add_space_after_user_token</span> <span class="k">else</span> <span class="n">newline_after_user_token</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newline_after_user_token</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">add_space_after_user_token</span> <span class="k">else</span> <span class="n">newline_after_user_token</span>
                <span class="p">)</span>
                <span class="n">newline_after_user_token</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">newline_after_user_token</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">add_newline_after_user_token</span>
                    <span class="k">else</span> <span class="n">newline_after_user_token</span>
                <span class="p">)</span>

            <span class="n">user_string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">user_token</span>
                <span class="o">+</span> <span class="n">newline_after_user_token</span>
                <span class="o">+</span> <span class="n">role</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;:&quot;</span> <span class="k">if</span> <span class="n">add_user_colon</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">add_user_newline</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">assistant_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">add_newline_after_user_message</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>
            <span class="n">assistant_string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">assistant_string</span>
                <span class="o">+</span> <span class="n">role</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;:&quot;</span> <span class="k">if</span> <span class="n">add_assistant_colon</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">add_assistant_newline</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">assistant_string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">add_newline_after_assistant_message</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>

            <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user_string</span><span class="p">,</span> <span class="n">assistant_string</span><span class="p">,</span> <span class="n">assistant_token</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">end_token</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">templates</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_message</span><span class="p">(</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">special_token_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Random</span><span class="p">],</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_mask_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">SHUFFLE_PROB</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">user_token</span> <span class="o">=</span> <span class="n">get_special_token</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="n">assistant_token</span> <span class="o">=</span> <span class="n">get_special_token</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">,</span> <span class="s2">&quot;assistant&quot;</span><span class="p">)</span>
    <span class="n">end_token</span> <span class="o">=</span> <span class="n">get_special_token</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span>
    <span class="n">system_token</span> <span class="o">=</span> <span class="n">get_special_token</span><span class="p">(</span><span class="n">special_token_format</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span>

    <span class="n">mask_start_token</span> <span class="o">=</span> <span class="n">get_mask_token</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
    <span class="n">mask_end_token</span> <span class="o">=</span> <span class="n">get_mask_token</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>

    <span class="n">template</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_token</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">assistant_token</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">end_token</span><span class="p">)</span>
    <span class="n">end_str</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">shuffle</span> <span class="ow">and</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SHUFFLE_PROB</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">_generate_chat_templates</span><span class="p">(</span><span class="nb">format</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">add_mask_tokens</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask_start_token</span> <span class="o">+</span> <span class="n">template</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="n">template</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">end_str</span> <span class="o">+</span> <span class="n">mask_end_token</span>
        <span class="k">return</span> <span class="n">template</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="n">template</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">end_str</span>

    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">template</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="n">end_str</span>

    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">add_mask_tokens</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask_start_token</span> <span class="o">+</span> <span class="n">system_token</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="n">end_str</span> <span class="o">+</span> <span class="n">mask_end_token</span>
        <span class="k">return</span> <span class="n">system_token</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="n">end_str</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`role` must be &#39;user&#39;, &#39;assistant&#39;, or &#39;system&#39;, but got &#39;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="apply_chat_template">
<a class="viewcode-back" href="../../../../api/datasets.html#phyagi.datasets.rl.formatting_utils.apply_chat_template">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_chat_template</span><span class="p">(</span>
    <span class="n">example</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span>
    <span class="n">special_token_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_mask_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">system_message_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
    <span class="n">system_message_prob</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply chat template to a given example.</span>

<span class="sd">    An example is a dictionary with task-related keys, e.g., ``prompt``, ``completion`` ``chosen``,</span>
<span class="sd">    ``rejected``, etc. each containing a list of messages, where each message is a dictionary with</span>
<span class="sd">    ``role`` and ``content``. For ``prompt`` key, an optional system message is additionally added</span>
<span class="sd">    ``system_message_format`` and ``system_message_prob`` arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        example: Example to apply chat template.</span>
<span class="sd">        special_token_format: Format of the special tokens, e.g., ``phi`` or ``chatml``.</span>
<span class="sd">        shuffle: Whether to shuffle templates.</span>
<span class="sd">        add_mask_tokens: Whether to add mask tokens.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Example with chat template applied.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">VALID_EXAMPLE_KEYS_FOR_SYSTEM</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>

    <span class="n">formatted_example</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">formatted_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">random_seed</span> <span class="o">=</span> <span class="n">Random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">VALID_EXAMPLE_KEYS_FOR_SYSTEM</span> <span class="ow">and</span> <span class="n">example</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">system_message_prob</span><span class="p">):</span>  <span class="c1"># 25% chance by default</span>
                <span class="k">if</span> <span class="n">system_message_format</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
                    <span class="n">system_message</span> <span class="o">=</span> <span class="n">random_seed</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">_generate_system_messages</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">system_message_format</span> <span class="o">==</span> <span class="s2">&quot;cot_final&quot;</span><span class="p">:</span>
                    <span class="n">system_message</span> <span class="o">=</span> <span class="s2">&quot;You are Phi, a language model trained by Microsoft to help users. Your role as an assistant involves thoroughly exploring questions through a systematic thinking process before providing the final precise and accurate solutions. This requires engaging in a comprehensive cycle of analysis, summarizing, exploration, reassessment, reflection, backtracing, and iteration to develop well-considered thinking process. Please structure your response into two main sections: Thought and Solution using the specified format: &lt;think&gt; {Thought section} &lt;/think&gt; {Solution section}. In the Thought section, detail your reasoning process in steps. Each step should include detailed considerations such as analysing questions, summarizing relevant findings, brainstorming new ideas, verifying the accuracy of the current steps, refining any errors, and revisiting previous steps. In the Solution section, based on various attempts, explorations, and reflections from the Thought section, systematically present the final solution that you deem correct. The Solution section should be logical, accurate, and concise and detail necessary steps needed to reach the conclusion. Now, try to solve the following question through the above guidelines:&quot;</span>
                <span class="k">elif</span> <span class="n">system_message_format</span> <span class="o">==</span> <span class="s2">&quot;cot_tools&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`system_message_format=&#39;cot_tools&#39;` is not implemented yet.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;`system_message_format` must be one of [&#39;random&#39;, &#39;cot_final&#39;, &#39;cot_tools&#39;], but got &#39;</span><span class="si">{</span><span class="n">system_message_format</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="n">example</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_message</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">example</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">formatted_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_format_message</span><span class="p">(</span>
                    <span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span>
                    <span class="n">message</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span>
                    <span class="n">special_token_format</span><span class="p">,</span>
                    <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                    <span class="n">add_mask_tokens</span><span class="o">=</span><span class="n">add_mask_tokens</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">formatted_example</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_messages</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">formatted_example</span></div>



<div class="viewcode-block" id="patch_tokenizer_generation_tag">
<a class="viewcode-back" href="../../../../api/datasets.html#phyagi.datasets.rl.formatting_utils.patch_tokenizer_generation_tag">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">patch_tokenizer_generation_tag</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedTokenizerBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Patch a tokenizer if it does not have support for generating assistant masks (by using % generation % Jinja tags).</span>

<span class="sd">    Args:</span>
<span class="sd">        tokenizer: Tokenizer to patch.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tokenizer with patched generation tags.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chat_template</span> <span class="o">=</span> <span class="n">GEN_TEMPLATE_PATCHES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">name_or_path</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">or</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span>
    <span class="k">if</span> <span class="n">chat_template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">name_or_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; must have a `chat_template`, but got None.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="sa">r</span><span class="s2">&quot;{</span><span class="si">% g</span><span class="s2">eneration %}&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chat_template</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">name_or_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; does not have &#39;% generation %&#39; Jinja tags, must be one of </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">GEN_TEMPLATE_PATCHES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="o">=</span> <span class="n">chat_template</span>

    <span class="k">return</span> <span class="n">tokenizer</span></div>

</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Microsoft
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  Last updated on Sep 16, 2025.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>